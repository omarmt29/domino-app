<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de Puntos de Dominó</title>

    <script async src="https://docs.opencv.org/master/opencv.js" type="text/javascript"></script>

    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        video, canvas {
            margin: 10px 0;
            border: 1px solid #ddd;
            max-width: 90%;
        }
        #canvasOutput {
            filter: blur(5px);
        }
        #startButton {
            margin: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #startButton:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Detector de Puntos de Dominó</h1>

    <!-- Botón para solicitar permisos y acceder a la cámara -->
    <button id="startButton">Acceder a la cámara</button>

    <!-- Elemento de video para mostrar la cámara -->
    <video id="video" autoplay playsinline></video>

    <!-- Canvases para procesar la imagen -->
    <canvas id="canvas" width="640" height="480"></canvas>
    <canvas id="canvasOutput" width="640" height="480"></canvas>

    <p>Posiciona una ficha de dominó frente a la cámara.</p>

    <script>
        // Obtener el botón y los elementos de video y canvas
        const startButton = document.getElementById('startButton');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const canvasOutput = document.getElementById('canvasOutput');
        const ctx = canvas.getContext('2d');
        const ctxOutput = canvasOutput.getContext('2d');

        // Función para iniciar la cámara
        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    video.srcObject = stream;
                })
                .catch((err) => {
                    console.error('Error al acceder a la cámara:', err);
                    alert('No se pudo acceder a la cámara. Asegúrate de que los permisos estén habilitados.');
                });
        }

        // Función para procesar el video
        function processVideo() {
            setInterval(() => {
                // Dibujar el fotograma actual del video en el canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Procesar la imagen con OpenCV.js
                const src = cv.imread(canvas);
                const dst = new cv.Mat();

                // Convertir a escala de grises
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

                // Aplicar un filtro de umbral para mejorar el contraste
                cv.threshold(dst, dst, 100, 255, cv.THRESH_BINARY);

                // Detectar contornos
                const contours = new cv.MatVector();
                const hierarchy = new cv.Mat();
                cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                // Dibujar los contornos en el canvas de salida
                const output = new cv.Mat();
                cv.cvtColor(dst, output, cv.COLOR_GRAY2RGBA);
                for (let i = 0; i < contours.size(); i++) {
                    const color = new cv.Scalar(0, 255, 0, 255);
                    cv.drawContours(output, contours, i, color, 2, cv.LINE_8, hierarchy, 0);
                }
                cv.imshow('canvasOutput', output);

                // Limpiar la memoria
                src.delete();
                dst.delete();
                contours.delete();
                hierarchy.delete();
                output.delete();
            }, 100);
        }

        // Agregar evento al botón para iniciar la cámara
        startButton.addEventListener('click', () => {
            startCamera();
            processVideo();
        });
    </script>
</body>
</html>
